<h1>Plan <%= @plan.name %> <%= '(child of %s)' % link_to(@plan.parent.name, project_plan_path(@project, @plan.parent)) if @plan.parent %></h1>

<ul class="action-list">
  <% if current_user.can_edit_plan?(@plan) %>
    <li><%= link_to 'Edit', edit_project_plan_path(@project, @plan) %></li>
  <% end %>
  <li><%= link_to 'Builds', project_plan_builds_path(@project, @plan) %></li>
  <% if current_user.can_create_plans? %>
    <li><%= link_to 'Clone', new_project_plan_path(@project, :clone => @plan) %></li>
  <% end %>
  <% if @plan.parent %>
    <% if current_user.can_edit_plan?(@plan) %>
      <li><%= link_to 'Move to another Parent', child_project_plan_path(@project) %></li>
      <li><%= link_to 'Convert to Standalone Plan', project_plan_path(@project, :plan => { :parent_id => nil }), :method => :put %></li>
    <% end %>
  <% else %>
    <% if current_user.can_create_plans? %>
      <li><%= link_to 'New Child Plan', new_project_plan_path(@project, :parent => @plan) %></li>
    <% end %>
    <% if !@plan.has_children? && current_user.can_edit_plan?(@plan) %>
      <li><%= link_to 'Convert to Child Plan', child_project_plan_path(@project) %></li>
    <% end %>
  <% end %>
  <% if current_user.can_destroy_plan?(@plan) %>
    <li><%= link_to 'Delete', project_plan_path(@project), :method => :delete, :confirm => 'Do you really want to delete this plan and all its children and builds? This operation can not be undone.' %></li>
  <% end %>
</ul>

<% if @plan.previous || @plan.next %>
  <h2>Build chain</h2>
  
  <table>
    <tr>
      <% if @plan.previous %>
        <td><%= link_to @plan.previous.name, project_plan_path(@project, @plan.previous) %></td>
      <% end %>
      <td><%= @plan.name %></td>
      <% if @plan.next %>
        <td><%= link_to @plan.next.name, project_plan_path(@project, @plan.next) %></td>
      <% end %>
    </tr>
  </table>
<% end %>

<% if @plan.has_children? %>
  <h2>Children</h2>
  
  <%= render :partial => "list", :locals => { :plans => @plan.children } %>
<% end %>

<h2>Plan details</h2>

<dl>
  <% if @plan.status %>
    <dt>Status</dt>
    <dd><%= image_tag "icons/large/#{@plan.status}.png" %> <span><%= @plan.status %> <%= link_to 'Latest Build', project_plan_build_path(@project, @plan, @plan.last_finished_build) %></span></dd>
  <% end %>

  <% if @plan.weather %>
    <dt>Weather</dt>
    <dd><%= image_tag "icons/large/weather-#{@plan.weather}.png" %> <span><%= @plan.weather %> of the last 5 builds were successful.</span></dd>
  <% end %>

  <dt>Description</dt>
  <dd><%= simple_format @plan.description %></dd>

  <dt>Steps</dt>
  <dd><pre><%= @plan.steps %></pre></dd>

  <dt>Requirements</dt>
  <dd><%= @plan.requirements %>&nbsp;</dd>
  
  <% if @plan.standalone? %>
    <dt>Commit Hook</dt>
    <dd>
      <table>
        <tr>
          <th>URL</th>
          <td><%= text_field_tag nil, project_plan_builds_url(@project, @plan), :size => 80 %></td>
        </tr>
        <tr>
          <th>wget</th>
          <td><%= text_field_tag nil, %{wget --post-data="" --output-file=/dev/null #{project_plan_builds_url(@project, @plan)}}, :size => 80 %></td>
        </tr>
        <tr>
          <th>curl</th>
          <td><%= text_field_tag nil, %{curl --data "" --output /dev/null --silent #{project_plan_builds_url(@project, @plan)}}, :size => 80 %></td>
        </tr>
      </table>
    </dd>
  <% end %>
</dl>

<% if @plan.standalone? %>
  <%= button_to 'Build now', project_plan_builds_path(@project, @plan) %>
<% else %>
  <p><%= link_to 'Back to parent plan %s' % @plan.parent.name, project_plan_path(@project, @plan.parent) %></p>
<% end %>

<p>Back to project <%= link_to @project.name, project_plans_path(@project) %></p>
